<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.board.mapper.member.MemberMapper">
    <!-- 멤버의 모든 column -->
    <sql id = "member_cols">
        no
        , phone
        , withdrawn_at
        , pw
        , id
        , name
        , email 
    </sql>

    <!-- 새로운 멤버 등록 (회원가입) -->
    <insert id = "insMember" parameterType="com.board.dto.member.InsMemberDTO" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO member (
            name
            , id
            , pw
            , email
            , phone
        ) VALUES (
            #{name}
            , #{id} 
            , #{pw} 
            , #{email} 
            , #{phone} 
        );
    </insert>

    <!-- 멤버 선택 -->
    <select id = "selectOne" parameterType="com.board.dto.member.SelectMemberDTO" resultType = "com.board.dto.member.MemberDTO">
        SELECT 
        <include refid = "member_cols" />
        FROM 
            member
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="email != null">
                AND email = #{email}
            </if>
        </where>

    </select>

    <!-- 멤버 인증 정보 저장 -->
    <insert id="insMemberAuth" parameterType="com.board.dto.member.MemberAuthDTO">
        INSERT INTO member_auth (
            member_no
            , access_token
            , ip_addr
            , user_agent
            , status
            , created_at
        ) VALUES (
            #{memberNo}
            , #{accessToken}
            , #{ipAddr}
            , #{userAgent}
            , #{status}
            , UNIX_TIMESTAMP()
        )
    </insert>

    <!-- 이미 로그인되어 있는지 여부 확인 -->
    <select id="isAlreadySignedIn" parameterType="java.lang.Integer" resultType="java.lang.Boolean">
        SELECT 
            CASE WHEN COUNT(*) > 0 THEN true ELSE false END
        FROM 
            member_auth
        WHERE 
            member_no = #{memberNo}
            AND status = 'VALID'
    </select>

    <!-- 멤버 로그인 히스토리 저장 -->
    <insert id="insMemberHistory" parameterType="com.board.dto.member.MemberHistoryDTO">
       INSERT INTO member_history (
            type 
            , timestamp
            , member_no
        ) VALUES (
            #{type}
            , UNIX_TIMESTAMP()
            , #{memberNo}
        ) 
    </insert>

    <!-- 로그아웃하며 access token 만료 -->
    <update id="expireMemberAuth" parameterType="com.board.dto.member.SignoutRequestDTO">
        UPDATE 
            member_auth
        SET
            status = 'EXPIRED'
        WHERE
            access_token = #{accessToken}
    </update>

    <!-- selectMemberDetail -->
    <select id="selectMemberDetail" resultType="com.board.dto.member.SelectMemberDetailDTO">
        SELECT
            no
            , name
            , id
            , email
            , phone
        FROM
            member
        WHERE
            no = #{memberNo}
    </select>

    <!-- updateMemberDetail -->

    <update id="updateMemberDetail" parameterType="com.board.dto.member.PutMemberDetailDTO">
        UPDATE
            member
        SET
            name = #{name}
            , pw = #{pw}
            , email = #{email}
            , phone = #{phone}
        WHERE
            no = #{no}

    </update>

    <!-- 회원탈퇴 -->
    <update id="withdraw">
        UPDATE
            member
        SET
            withdrawn_at = UNIX_TIMESTAMP()
        WHERE
            no = #{memberNo}
    </update>
</mapper>